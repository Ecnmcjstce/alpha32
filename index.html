<script>
    // --- CONFIGURATION ---
    const OANDA_API_TOKEN = '<script>
    // --- CONFIGURATION ---
    const OANDA_API_TOKEN = '<script>
    // --- CONFIGURATION ---
    const OANDA_API_TOKEN = 'b8c35ee0f8186bd5e7101c0966a6290e-8af8c0f946b95a77f1801e51a739efaf'; // Replace with your token
    const OANDA_ACCOUNT_ID = '001-001-19686413-001'; // Replace with your OANDA account ID
    let activePairs = ["EUR/USD","GBP/USD","USD/JPY","USD/CAD"];
    let marketData = {};
    let streamController = null;

    function initializeState() {
        marketData = {};
        activePairs.forEach(pair => {
            marketData[pair] = {
                price: 0,
                history: [],
                emaFast: 0,
                emaSlow: 0,
                alphaScore: 0,
                signal: 'NEUTRAL',
                bias: 0,
                lastAlert: 0
            };
        });
        renderTable();
    }

    async function connectOandaStream() {
        initializeState();
        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('analysis-table-container').classList.remove('hidden');
        document.getElementById('sim-indicator').classList.add('hidden');
        updateStatus('connecting', 'Connecting to OANDA');

        const instruments = activePairs.map(p => p.replace('/','_')).join(',');
        const url = `https://stream-fxpractice.oanda.com/v3/accounts/${OANDA_ACCOUNT_ID}/pricing/stream?instruments=${instruments}`;

        try {
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${OANDA_API_TOKEN}`
                }
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");

            updateStatus('online','Live Stream Active');

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const lines = decoder.decode(value).split('\n');
                lines.forEach(line => {
                    if (!line) return;
                    const data = JSON.parse(line);
                    if (data.type === 'PRICE') {
                        const pair = data.instrument.replace('_','/');
                        const midPrice = (parseFloat(data.bids[0].price) + parseFloat(data.asks[0].price))/2;
                        updateMarket(pair, midPrice);
                    }
                });
            }
        } catch(err) {
            console.error('Stream error:', err);
            updateStatus('offline','Disconnected');
            // Attempt reconnect after 5 seconds
            setTimeout(connectOandaStream, 5000);
        }
    }

    // --- UPDATE MARKET FUNCTION (from your current code) ---
    function updateMarket(pair, price) {
        const d = marketData[pair];
        if (!d) return;
        d.price = price;
        d.history.push(price);
        if (d.history.length > 50) d.history.shift();

        const aF = 0.22, aS = 0.09;
        d.emaFast = d.emaFast === 0 ? price : (price * aF) + (d.emaFast * (1 - aF));
        d.emaSlow = d.emaSlow === 0 ? price : (price * aS) + (d.emaSlow * (1 - aS));

        const delta = d.emaFast - d.emaSlow;
        d.bias = delta;
        const sens = 500;
        const score = 50 + (delta * sens);
        d.alphaScore = Math.max(0, Math.min(Math.floor(score), 100));

        const prevSignal = d.signal;
        if (d.alphaScore > 80) d.signal = 'BUY';
        else if (d.alphaScore < 20) d.signal = 'SELL';
        else d.signal = 'NEUTRAL';

        if (d.signal !== 'NEUTRAL' && d.signal !== prevSignal) {
            playTone(d.signal);
        }
        renderTable();
    }

    // --- AUDIO ALERT FUNCTION ---
    function playTone(freqType) {
        if (!document.getElementById('audio-toggle').checked) return;
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.frequency.setValueAtTime(freqType === 'BUY' ? 880 : 440, audioCtx.currentTime);
        g.gain.setValueAtTime(0.05, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
        osc.connect(g);
        g.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }
